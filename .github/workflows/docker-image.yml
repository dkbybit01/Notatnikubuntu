name: CI â€” Docker build verification

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-images:
    name: Build images for services
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - name: backend
            path: ./backend
            tag: notatnik_backend:ci
          - name: frontend
            path: ./frontend
            tag: notatnik_frontend:ci

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU (multi-arch support)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Inspect build context (debug)
        run: |
          echo "Service: ${{ matrix.name }}"
          echo "Context path: ${{ matrix.path }}"
          ls -la "${{ matrix.path }}" || true
          echo "Root files:"
          ls -la

      - name: Ensure Dockerfile exists
        run: |
          if [ -f "${{ matrix.path }}/Dockerfile" ]; then
            echo "Dockerfile found in ${{ matrix.path }}"
          else
            echo "ERROR: No Dockerfile in ${{ matrix.path }}" >&2
            exit 1
          fi

      - name: Build image with buildx (no push)
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.path }}
          file: ${{ matrix.path }}/Dockerfile
          push: false
          tags: ${{ matrix.tag }}
          platforms: linux/amd64

      - name: Build finished
        run: echo "Build finished for ${{ matrix.name }}"
